workflows:
  react-native-ios:
    name: React Native iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    integrations:
      app_store_connect: Codemagic Key # Codemagic UI'da verdiğiniz anahtar ismi
    environment:
      groups:
        - apple_auth
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.gkhnkyhns.matchtalk
      vars:
        XCODE_WORKSPACE: "MatchTalk.xcworkspace"
        XCODE_SCHEME: "MatchTalk"
        # Sentry Configuration (DSN remains static, others come from apple_auth group)
        SENTRY_DSN: "https://c7e5e5f668ef8b9a836eb2cf9e018325@o4510601386459136.ingest.de.sentry.io/4510601993977936"
        SENTRY_ENABLED: "true"
        # These will be fetched from the App Store Connect integration or environment groups
        # APP_STORE_CONNECT_ISSUER_ID: "..."
        # APP_STORE_CONNECT_KEY_IDENTIFIER: "..."
        # APP_STORE_CONNECT_PRIVATE_KEY: "..."
      node: v18.18.0
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install npm dependencies
        script: npm install
      - name: Expo Prebuild
        script: |
          # Generates the native iOS projects
          npx expo prebuild --platform ios
          # Patch Podfile with advanced flags for Xcode 16 and Architecture exclusions
          ruby -e "text=File.read('ios/Podfile'); text=text.gsub(/^platform :ios, .*/, \"platform :ios, '18.0'\"); new_text=text.gsub('post_install do |installer|', \"post_install do |installer|\\n    installer.pods_project.targets.each do |target|\\n      target.build_configurations.each do |config|\\n        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.0'\\n        config.build_settings['ENABLE_BITCODE'] = 'NO'\\n        config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'gnu++20'\\n        config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'\\n        config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'x86_64'\\n        config.build_settings['SWIFT_VERSION'] = '5.0'\\n        config.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = target.name == 'MatchTalk' ? 'YES' : 'NO'\\n        config.build_settings['LIBRARY_SEARCH_PATHS'] = ['$(inherited)', '$(SDKROOT)/usr/lib/swift']\\n        config.build_settings['DEAD_CODE_STRIPPING'] = 'NO'\\n      end\\n    end\"); File.write('ios/Podfile', new_text)"
      - name: Fetch certificates and signing files
        script: |
          # Önce anahtarlığı (keychain) temiz bir şekilde başlatıyoruz
          keychain initialize
          # Apple'dan yeşil onaylı dosyaları çekiyoruz
          app-store-connect fetch-signing-files "com.gkhnkyhns.matchtalk" --type IOS_APP_STORE --create
          # İndirilen sertifikaları keychain'e ekliyoruz
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles --warn-only && ls -l ~/Library/MobileDevice/Provisioning\ Profiles
      - name: Install CocoaPods dependencies
        script: |
          cd ios && pod install
      - name: Build iOS App (.ipa)
        script: |
          xcode-project build-ipa \
            --workspace ios/$XCODE_WORKSPACE \
            --scheme $XCODE_SCHEME \
            --config Release
      - name: Upload Sentry Source Maps
        script: |
          # Use variables from environment group (apple_auth)
          export SENTRY_LOG_LEVEL=info

          VERSION=$(node -p "require('./package.json').version")
          echo "Uploading source maps for version $VERSION"

          npx @sentry/cli info

          npx @sentry/cli releases new "$VERSION"
          npx @sentry/cli releases files "$VERSION" upload-sourcemaps \
            ios/build/Build/Products/Release-iphoneos/MatchTalk.app \
            --rewrite
          npx @sentry/cli releases finalize "$VERSION"

          echo "Sentry source maps upload completed"
    artifacts:
      - build/ios/ipa/*.ipa
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
